<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: views/ContactView.jsx</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: views/ContactView.jsx</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import React, { useEffect, useState } from 'react';
import { Button, TextField, MenuItem, Grid, Box, Dialog, DialogActions, DialogContent, DialogTitle } from '@mui/material';
import ContactList from '../components/ContactList';
import axios from 'axios';

/**
 * Normaliza una cadena de texto, eliminando acentos y convirtiéndola a minúsculas.
 * @param {string} str - La cadena de texto a normalizar.
 * @returns {string} - La cadena normalizada, sin acentos y en minúsculas.
 */
const normalizeString = (str) => {
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toLowerCase();
};

const Contactos = () => {
  // Estado para almacenar la lista de practitioners (contactos)
  const [practitioners, setPractitioners] = useState([]);
  // Estado que almacena los contactos filtrados después de aplicar filtros de búsqueda
  const [filteredPractitioners, setFilteredPractitioners] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

// Estados que controlan los filtros disponibles en la vista
  const [cargo, setCargo] = useState('');
  const [especialidad, setEspecialidad] = useState('');
  const [establecimiento, setEstablecimiento] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [locations, setLocations] = useState([]);

  // Estado para el modal de agregar/editar contacto
  // Estado que controla la apertura y cierre del modal para agregar o editar un contacto
  const [open, setOpen] = useState(false);
  // Estado que define si el modal está en modo de edición o creación de contacto
  const [isEditing, setIsEditing] = useState(false);
  // Estado que almacena el contacto que se está editando (si aplica)
  const [editingContactId, setEditingContactId] = useState(null);

  // Estado del formulario de contacto
  const [newContact, setNewContact] = useState({
    familyName: '',
    givenName: '',
    identifier: '',
    phone: '',
    address: '',
    city: '',
    postalCode: '',
    country: '',
    gender: '',
    birthDate: '',
    qualification: '',
    qualificationIssuer: '',
    email: '' 
  });

   /**
   * Cargar los practitioners desde el servidor FHIR.
   */
  useEffect(() => {
    const fetchPractitioners = async () => {
      try {
        const response = await axios.get('http://localhost:8080/fhir/Practitioner');
        const practitionersData = response.data.entry.map(entry => entry.resource);
        setPractitioners(practitionersData);
        setFilteredPractitioners(practitionersData);
        setLoading(false);
      } catch (error) {
        setError('Error al cargar los datos');
        setLoading(false);
      }
    };
    fetchPractitioners();
    /**
     * Cargar los establecimientos desde el servidor FHIR.
     */
    const fetchLocations = async () => {
      try {
        const response = await axios.get('http://localhost:8080/fhir/Location');
        const locationData = response.data.entry.map(entry => entry.resource);
        setLocations(locationData);
      } catch (error) {
        console.error('Error al cargar los establecimientos:', error);
      }
    };
    fetchLocations();
  }, []);

  /**
   * Aplicar los filtros a la lista de practitioners.
   */
  const applyFilters = () => {
    let filtered = practitioners;
  // Filtro por cargo
    if (cargo) {
      filtered = filtered.filter(practitioner => 
        practitioner.qualification?.some(q => q.code?.text?.toLowerCase().includes(cargo.toLowerCase()))
      );
    }
  // Filtro por especialidad
    if (especialidad) {
      filtered = filtered.filter(practitioner => 
        practitioner.qualification?.some(q => q.code?.text?.toLowerCase().includes(especialidad.toLowerCase()))
      );
    }
  // Filtro por establecimiento
    if (establecimiento) {
      filtered = filtered.filter(practitioner => 
        practitioner.address?.some(a => 
          normalizeString(a.city || '').includes(normalizeString(establecimiento)) ||
          a.line?.some(line => normalizeString(line).includes(normalizeString(establecimiento)))
        )
      );
    }
  
    setFilteredPractitioners(filtered);
  };

    /**
   * Realizar la búsqueda de contactos basados en el nombre.
   */
  useEffect(() => {
    let filtered = practitioners;

    if (searchQuery) {
      filtered = filtered.filter(practitioner => 
        normalizeString(practitioner.name?.[0]?.given?.join(' ') || '').includes(normalizeString(searchQuery)) ||
        normalizeString(practitioner.name?.[0]?.family || '').includes(normalizeString(searchQuery))
      );
    }

    setFilteredPractitioners(filtered);
  }, [searchQuery, practitioners]);

  /**
   * Resetear los filtros a sus valores iniciales.
   */
  const resetFilters = () => {
    setCargo('');
    setEspecialidad('');
    setEstablecimiento('');
    setSearchQuery('');
    setFilteredPractitioners(practitioners);
  };

/**
   * Abrir el modal de agregar/editar contacto.
   */
  const handleOpen = () => setOpen(true);
  /**
   * Cerrar el modal y resetear el estado.
   */
  const handleClose = () => {
    setOpen(false);
    setIsEditing(false);
    setEditingContactId(null);
    // Resetear el formulario
    setNewContact({
      familyName: '',
      givenName: '',
      identifier: '',
      phone: '',
      address: '',
      city: '',
      postalCode: '',
      country: '',
      gender: '',
      birthDate: '',
      qualification: '',
      qualificationIssuer: '',
      email: ''
    });
  };

    /**
   * Manejar el cambio de valor en el formulario.
   * @param {object} e - El evento de cambio.
   */
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setNewContact({ ...newContact, [name]: value });
  };

    /**
   * Abrir el modal en modo de edición.
   * @param {object} contact - El contacto que se desea editar.
   */
const handleEditClick = (contact) => {
  setIsEditing(true);
  setEditingContactId(contact.id);
  setNewContact({
    familyName: contact.name?.[0]?.family || '',
    givenName: contact.name?.[0]?.given?.join(' ') || '',
    identifier: contact.identifier?.[0]?.value || '',
    phone: contact.telecom?.find(t => t.system === 'phone')?.value || '',
    address: contact.address?.[0]?.line?.[0] || '',
    city: contact.address?.[0]?.city || '',
    postalCode: contact.address?.[0]?.postalCode || '',
    country: contact.address?.[0]?.country || '',
    gender: contact.gender || '',
    birthDate: contact.birthDate || '',
    qualification: contact.qualification?.[0]?.code?.text || '',
    qualificationIssuer: contact.qualification?.[0]?.issuer?.display || '',
    email: contact.telecom?.find(t => t.system === 'email')?.value || '' // Aquí agregamos el email
  });
  handleOpen();
};

  /**
   * Agregar o editar un contacto en el servidor FHIR.
   */
  const handleSubmit = async () => {
    const practitionerData = {
      resourceType: 'Practitioner',
      identifier: [{ use: 'official', value: newContact.identifier }],
      active: true,
      name: [
        {
          family: newContact.familyName,
          given: newContact.givenName ? newContact.givenName.split(' ') : []
        }
      ],
      telecom: [
        { system: 'phone', value: newContact.phone },
        { system: 'email', value: newContact.email } // Agregar email aquí
      ],
      address: [
        {
          line: [newContact.address],
          city: newContact.city,
          postalCode: newContact.postalCode,
          country: newContact.country
        }
      ],
      gender: newContact.gender,
      birthDate: newContact.birthDate,
      qualification: [
        {
          code: { text: newContact.qualification },
          issuer: {
            reference: 'Organization/1', // Ajusta según sea necesario
            display: newContact.qualificationIssuer
          }
        }
      ]
    };
  
    try {
      if (isEditing &amp;&amp; editingContactId) {
        const patchData = [
          newContact.familyName &amp;&amp; { op: "replace", path: "/name/0/family", value: newContact.familyName },
          newContact.givenName &amp;&amp; { op: "replace", path: "/name/0/given", value: newContact.givenName.split(' ') },
          newContact.phone &amp;&amp; { op: "replace", path: "/telecom/0/value", value: newContact.phone },
          newContact.email &amp;&amp; { op: "replace", path: "/telecom/1/value", value: newContact.email }, // Email para editar
          newContact.address &amp;&amp; { op: "replace", path: "/address/0/line/0", value: newContact.address },
          newContact.city &amp;&amp; { op: "replace", path: "/address/0/city", value: newContact.city },
          newContact.postalCode &amp;&amp; { op: "replace", path: "/address/0/postalCode", value: newContact.postalCode },
          newContact.country &amp;&amp; { op: "replace", path: "/address/0/country", value: newContact.country },
          newContact.gender &amp;&amp; { op: "replace", path: "/gender", value: newContact.gender },
          newContact.birthDate &amp;&amp; { op: "replace", path: "/birthDate", value: newContact.birthDate },
          newContact.qualification &amp;&amp; { op: "replace", path: "/qualification/0/code/text", value: newContact.qualification },
          newContact.qualificationIssuer &amp;&amp; { op: "replace", path: "/qualification/0/issuer/display", value: newContact.qualificationIssuer }
        ].filter(Boolean);
  
        const response = await axios.patch(
          `http://localhost:8080/fhir/Practitioner/${editingContactId}`,
          patchData,
          { headers: { 'Content-Type': 'application/json-patch+json' } }
        );
  
        if (response.status === 200) {
          const updatedPractitioner = response.data;
          const updatedPractitioners = practitioners.map(p =>
            p.id === updatedPractitioner.id ? updatedPractitioner : p
          );
          setPractitioners(updatedPractitioners);
          setFilteredPractitioners(updatedPractitioners);
        }
      } else {
        const response = await axios.post(
          'http://localhost:8080/fhir/Practitioner',
          practitionerData,
          { headers: { 'Content-Type': 'application/fhir+json' } }
        );
  
        if (response.status === 201) {
          const createdPractitioner = response.data;
          const updatedPractitioners = [...practitioners, createdPractitioner];
          setPractitioners(updatedPractitioners);
          setFilteredPractitioners(updatedPractitioners);
        }
      }
  
      handleClose();
    } catch (error) {
      console.error('Error al procesar la solicitud:', error);
    }
  };
  
  

   /**
   * Eliminar un contacto.
   * @param {string} contactId - El ID del contacto que se desea eliminar.
   */
  const handleDeleteContact = async (id) => {
    try {
      await axios.delete(`http://localhost:8080/fhir/Practitioner/${id}`);
      const updatedPractitioners = practitioners.filter(p => p.id !== id);
      setPractitioners(updatedPractitioners);
      setFilteredPractitioners(updatedPractitioners);
    } catch (error) {
      console.error('Error al eliminar el contacto:', error);
    }
  };

  if (loading) return &lt;p>Cargando...&lt;/p>;
  if (error) return &lt;p>{error}&lt;/p>;

  return (
    &lt;Box sx={{ maxWidth: '1200px', margin: '0 auto', padding: '20px' }}>
      &lt;h1>Contactos&lt;/h1>

      {/* Botón para abrir el formulario de agregar contacto */}
      &lt;Button variant="contained" color="primary" onClick={handleOpen}>
        Agregar Contacto
      &lt;/Button>

      {/* Modal con el formulario de agregar/editar contacto */}
      &lt;Dialog open={open} onClose={handleClose}>
        &lt;DialogTitle>{isEditing ? 'Editar Contacto' : 'Agregar Nuevo Contacto'}&lt;/DialogTitle>
        &lt;DialogContent>
          &lt;Grid container spacing={2}>
            &lt;Grid item xs={12}>
              &lt;TextField label="Apellido" name="familyName" value={newContact.familyName} onChange={handleInputChange} fullWidth />
            &lt;/Grid>
            &lt;Grid item xs={12}>
              &lt;TextField label="Nombres" name="givenName" value={newContact.givenName} onChange={handleInputChange} fullWidth />
            &lt;/Grid>
           
            &lt;Grid item xs={12}>
              &lt;TextField label="Teléfono" name="phone" value={newContact.phone} onChange={handleInputChange} fullWidth />
            &lt;/Grid>
            &lt;Grid item xs={12}>
        &lt;TextField
          label="Email"
          name="email"
          value={newContact.email}
          onChange={handleInputChange}
          fullWidth
        />
      &lt;/Grid>
            &lt;Grid item xs={12}>
      &lt;TextField
        select
        label="Establecimiento"
        value={newContact.city}
        onChange={(e) => setNewContact({ ...newContact, city: e.target.value })}
        fullWidth
        SelectProps={{
          MenuProps: {
            PaperProps: {
              sx: {
                maxHeight: 200, // Altura máxima del menú desplegable
                width: 250      // Ancho del menú desplegable
              },
            },
          },
        }}
      >
        &lt;MenuItem value="">Selecciona un Establecimiento&lt;/MenuItem>
        {locations.map(location => (
          &lt;MenuItem key={location.id} value={location.name}>
            {location.name}
          &lt;/MenuItem>
        ))}
      &lt;/TextField>
    &lt;/Grid>
            &lt;Grid item xs={6}>
              &lt;TextField
                label="Género"
                name="gender"
                value={newContact.gender}
                onChange={handleInputChange}
                fullWidth
                select
              >
                &lt;MenuItem value="male">Masculino&lt;/MenuItem>
                &lt;MenuItem value="female">Femenino&lt;/MenuItem>
                &lt;MenuItem value="other">Otro&lt;/MenuItem>
              &lt;/TextField>
            &lt;/Grid>
            &lt;Grid item xs={6}>
  &lt;TextField
    select
    label="Cargo"
    name="qualification"
    value={newContact.qualification}
    onChange={handleInputChange}
    fullWidth
    SelectProps={{
      MenuProps: {
        PaperProps: {
          sx: {
            maxHeight: 200, // Altura máxima del menú desplegable
            width: 250      // Ancho del menú desplegable
          },
        },
      },
    }}
  >
    &lt;MenuItem value="">Selecciona un Cargo&lt;/MenuItem>
    &lt;MenuItem value="Médico">Médico&lt;/MenuItem>
    &lt;MenuItem value="Contralor">Contralor&lt;/MenuItem>
    &lt;MenuItem value="Priorizador">Priorizador&lt;/MenuItem>
  &lt;/TextField>
&lt;/Grid>
          &lt;/Grid>
        &lt;/DialogContent>
        &lt;DialogActions>
          &lt;Button onClick={handleClose} color="secondary">Cancelar&lt;/Button>
          &lt;Button onClick={handleSubmit} color="primary">
            {isEditing ? 'Actualizar' : 'Agregar'}
          &lt;/Button>
        &lt;/DialogActions>
      &lt;/Dialog>

      {/* Contenedor para los filtros y la lista */}
      &lt;Grid container spacing={2}>
        {/* Bloque de Filtros (Izquierda) */}
        &lt;Grid item xs={12} sm={4}>
          &lt;Box sx={{ paddingRight: '20px' }}>
            &lt;h2>Filtros&lt;/h2>

            {/* Filtros */}
            &lt;Grid container spacing={2}>
              &lt;Grid item xs={12}>
                &lt;TextField select label="Cargo" value={cargo} onChange={(e) => setCargo(e.target.value)} fullWidth>
                  &lt;MenuItem value="">Cargo&lt;/MenuItem>
                  &lt;MenuItem value="Médico">Médico&lt;/MenuItem>
                  &lt;MenuItem value="Contralor">Contralor&lt;/MenuItem>
                  &lt;MenuItem value="Priorizador">Priorizador&lt;/MenuItem>
                &lt;/TextField>
              &lt;/Grid>
              
              &lt;Grid item xs={12}>
  &lt;TextField
    select
    label="Establecimiento"
    value={establecimiento}
    onChange={(e) => setEstablecimiento(e.target.value)}
    fullWidth
    SelectProps={{
      MenuProps: {
        PaperProps: {
          sx: {
            maxHeight: 200, // Altura máxima del menú desplegable
            width: 250,     // Ancho del menú desplegable
          },
        },
      },
    }}
  >
    &lt;MenuItem value="">Establecimiento&lt;/MenuItem>
    {locations.map(location => (
      &lt;MenuItem key={location.id} value={location.name}>
        {location.name}
      &lt;/MenuItem>
    ))}
  &lt;/TextField>
&lt;/Grid>
              &lt;Grid item xs={12}>
                &lt;TextField label="Buscar" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} fullWidth />
              &lt;/Grid>

              &lt;Grid item xs={12}>
                &lt;Button fullWidth variant="contained" color="primary" onClick={applyFilters}>
                  Aplicar Filtros
                &lt;/Button>
              &lt;/Grid>

              &lt;Grid item xs={12}>
                &lt;Button fullWidth variant="contained" color="secondary" onClick={resetFilters}>
                  Limpiar Filtros
                &lt;/Button>
              &lt;/Grid>
            &lt;/Grid>
          &lt;/Box>
        &lt;/Grid>

        {/* Bloque de Contactos (Derecha) */}
        &lt;Grid item xs={12} sm={8}>
          &lt;h2>Lista de Contactos&lt;/h2>
          &lt;ContactList
            practitioners={filteredPractitioners}
            onDelete={handleDeleteContact}
            onEdit={handleEditClick}
          />
        &lt;/Grid>
      &lt;/Grid>
    &lt;/Box>
  );
};

export default Contactos;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#ContactCard">ContactCard</a></li><li><a href="global.html#ContactList">ContactList</a></li><li><a href="global.html#EspecialidadesView">EspecialidadesView</a></li><li><a href="global.html#ProtocoloView">ProtocoloView</a></li><li><a href="global.html#normalizeString">normalizeString</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Nov 07 2024 01:11:16 GMT-0300 (hora de verano de Chile)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
